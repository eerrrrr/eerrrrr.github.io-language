<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyGlot v20.0 | Notebook Evolved</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        [v-cloak] { display: none; }
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        
        .word-token { 
            cursor: pointer; padding: 2px 4px; margin: 0 1px; border-radius: 4px; display: inline-block; transition: all 0.1s;
        }
        .word-token:hover { background-color: rgba(99, 102, 241, 0.4); color: white; text-decoration: underline; }
        .punctuation { color: #64748b; margin-right: 2px; }
        .modal-overlay { background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        
        /* Notebook Card Edit Style */
        .edit-input { background: #1e293b; border: 1px solid #475569; color: white; padding: 4px 8px; border-radius: 6px; width: 100%; font-size: 0.875rem; margin-bottom: 4px; }
        .edit-input:focus { outline: none; border-color: #6366f1; }
    </style>
</head>
<body class="antialiased h-screen overflow-hidden flex">

    <div id="app" v-cloak class="w-full h-full flex">
        
        <div v-if="showAuthModal" class="fixed inset-0 z-50 modal-overlay flex items-center justify-center">
            <div class="bg-slate-800 p-8 rounded-3xl w-full max-w-md border border-slate-700 shadow-2xl text-center">
                <div class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-6 text-2xl text-white"><i class="fa-solid fa-book-open"></i></div>
                <h2 class="text-2xl font-bold text-white mb-2">PolyGlot v20</h2>
                <p class="text-slate-400 text-sm mb-6">Notebook Evolved: Catalogs & Editing.</p>
                <input v-model="tempKey" type="password" placeholder="AIza..." class="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:border-indigo-500 outline-none mb-4 font-mono text-center">
                <div v-if="loginError" class="mb-4 text-red-400 text-xs bg-red-900/20 p-3 rounded-lg">{{ loginError }}</div>
                <button @click="verifyKey" :disabled="!tempKey || isLoading" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold transition mb-4">
                    <span v-if="isLoading"><i class="fa-solid fa-spinner fa-spin"></i> Connecting...</span>
                    <span v-else>Enable AI</span>
                </button>
                <button @click="skipLogin" class="text-slate-500 text-xs hover:text-white underline">Skip (Offline Mode)</button>
            </div>
        </div>

        <div v-if="showAddModal" class="fixed inset-0 z-50 modal-overlay flex items-center justify-center">
            <div class="bg-slate-800 p-6 rounded-2xl w-full max-w-lg border border-slate-700 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">Add New Entry</h3>
                    <button @click="showAddModal = false" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Type</label>
                        <div class="flex gap-2">
                            <button @click="newEntry.type = 'word'" :class="['flex-1 py-2 rounded-lg text-xs font-bold border transition', newEntry.type === 'word' ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-slate-900 border-slate-700 text-slate-400']">Word</button>
                            <button @click="newEntry.type = 'sentence'" :class="['flex-1 py-2 rounded-lg text-xs font-bold border transition', newEntry.type === 'sentence' ? 'bg-amber-600 border-amber-500 text-white' : 'bg-slate-900 border-slate-700 text-slate-400']">Sentence</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Content ({{ currentLang.name }})</label>
                        <input v-model="newEntry.text" type="text" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:border-indigo-500 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase block mb-1">English Meaning</label>
                            <input v-model="newEntry.meaning_en" type="text" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:border-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Chinese Meaning</label>
                            <input v-model="newEntry.meaning_cn" type="text" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:border-indigo-500 outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Category (Catalog)</label>
                        <input v-model="newEntry.category" list="categoryOptions" type="text" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white focus:border-indigo-500 outline-none" placeholder="e.g. Lesson 1">
                        <datalist id="categoryOptions">
                            <option v-for="c in categories" :value="c"></option>
                        </datalist>
                    </div>
                    <button @click="saveNewEntry" :disabled="!newEntry.text" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold transition mt-4 disabled:opacity-50">Save to Notebook</button>
                </div>
            </div>
        </div>

        <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col h-full shrink-0">
            <div class="p-6">
                <h1 class="text-xl font-black text-white flex items-center gap-2"><i class="fa-solid fa-brain text-indigo-500"></i> PolyGlot</h1>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-1">v20.0 Evolved</p>
            </div>

            <div class="px-4 mb-4">
                <label class="text-[10px] font-bold text-slate-500 uppercase block mb-2">Target Language</label>
                <div class="grid grid-cols-2 gap-2">
                    <button v-for="lang in languages" :key="lang.name" @click="currentLang = lang" 
                        :class="['px-2 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition', currentLang.name === lang.name ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700']">
                        <span>{{ lang.flag }}</span> {{ lang.name }}
                    </button>
                </div>
            </div>

            <nav class="flex-1 px-2 space-y-1 overflow-y-auto custom-scrollbar">
                <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id"
                    :class="['w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition', activeTab === tab.id ? 'bg-indigo-500/10 text-indigo-400 border border-indigo-500/20' : 'text-slate-400 hover:text-white hover:bg-slate-800']">
                    <i :class="['fa-solid w-5 text-center', tab.icon]"></i> {{ tab.label }}
                </button>
            </nav>

            <div class="p-4 border-t border-slate-800">
                <button @click="showAuthModal = true" class="text-xs text-slate-400 flex items-center gap-2 hover:text-white w-full px-2 py-2 rounded hover:bg-slate-800 transition">
                    <i :class="isValidKey ? 'fa-solid fa-key text-green-400' : 'fa-solid fa-lock text-red-400'"></i> 
                    {{ isValidKey ? 'Settings' : 'Login' }}
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-950 relative">
            <header class="h-16 border-b border-slate-800 flex items-center justify-between px-8 bg-slate-900/50 backdrop-blur">
                <h2 class="text-lg font-bold text-white capitalize">{{ activeTab.replace('-', ' ') }}</h2>
                <div class="flex items-center gap-4 text-xs text-slate-400">
                    <span v-if="isValidKey" class="text-green-400 flex items-center gap-1"><i class="fa-solid fa-bolt"></i> Online</span>
                    <span v-else class="text-slate-500 flex items-center gap-1"><i class="fa-solid fa-power-off"></i> Offline</span>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8 custom-scrollbar relative">
                
                <div v-if="activeTab === 'import'" class="max-w-4xl mx-auto">
                    <div class="bg-slate-900 p-8 rounded-3xl border border-slate-800">
                        <h3 class="text-2xl font-bold text-white mb-2">Import & Read</h3>
                        <p class="text-slate-400 text-sm mb-6">Paste text (from PDF) or JSON Code.</p>
                        <textarea v-model="importText" rows="10" class="w-full bg-slate-950 border border-slate-700 rounded-xl p-4 text-slate-300 font-mono text-sm focus:border-indigo-500 outline-none mb-4" placeholder="Paste content here..."></textarea>
                        <div class="flex gap-4">
                            <button @click="processContent('json')" class="flex-1 py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold transition flex items-center justify-center gap-2"><i class="fa-solid fa-code"></i> Load JSON Lesson</button>
                            <button @click="processContent('raw')" class="flex-1 py-4 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-bold transition border border-slate-700">Read Raw Text</button>
                            <button @click="processContent('ai')" :disabled="!isValidKey" class="flex-1 py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition disabled:opacity-50">AI Analyze</button>
                        </div>
                    </div>
                </div>

                <div v-if="activeTab === 'news' && contentData" class="max-w-4xl mx-auto animate-in fade-in slide-in-from-bottom-4 pb-20">
                    <div class="flex justify-between items-center mb-4">
                        <button @click="contentData = null; activeTab = 'import'" class="text-slate-400 hover:text-white"><i class="fa-solid fa-arrow-left"></i> Back</button>
                        <button @click="speak(contentData.main_text)" class="text-indigo-400 hover:text-white"><i class="fa-solid fa-volume-high"></i> Read</button>
                    </div>
                    <div class="bg-white text-slate-900 p-10 rounded-3xl shadow-xl mb-6">
                        <h2 v-if="contentData.title" class="text-2xl font-black mb-6 border-b pb-4">{{ contentData.title }}</h2>
                        <div class="text-xl leading-relaxed font-medium font-serif">
                            <template v-for="(token, i) in splitText(contentData.main_text)" :key="i">
                                <span v-if="token.type === 'newline'" class="block h-4"></span>
                                <span v-else-if="token.type === 'word'" @click="lookupWord(token.text)" class="word-token">{{ token.text }}</span>
                                <span v-else class="punctuation">{{ token.text }}</span>
                            </template>
                        </div>
                    </div>
                    <div v-if="contentData.vocabulary" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                            <h4 class="text-xs font-bold text-indigo-400 uppercase mb-4">Translation</h4>
                            <p class="text-sm text-slate-300 mb-2"><strong>EN:</strong> {{ contentData.translation_en }}</p>
                            <p class="text-sm text-slate-300"><strong>CN:</strong> {{ contentData.translation_cn }}</p>
                        </div>
                        <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800 max-h-80 overflow-y-auto custom-scrollbar">
                            <h4 class="text-xs font-bold text-emerald-400 uppercase mb-4">Vocabulary</h4>
                            <div v-for="v in contentData.vocabulary" :key="v.word" class="flex justify-between items-center py-2 border-b border-slate-800 last:border-0">
                                <div><span class="text-white font-bold block">{{ v.word }}</span><span class="text-slate-500 text-xs">{{ v.meaning_cn }}</span></div>
                                <button @click="addToNotebook({text: v.word, meaning_en: v.meaning_en, meaning_cn: v.meaning_cn, type: 'word'})" class="text-indigo-500 hover:text-emerald-400 p-2"><i class="fa-solid fa-plus-circle fa-lg"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeTab === 'notebook'" class="max-w-6xl mx-auto h-full flex flex-col">
                    
                    <div class="flex justify-between items-end mb-6 pb-4 border-b border-slate-800">
                        <div>
                            <h3 class="text-2xl font-bold text-white mb-2">Knowledge Bank</h3>
                            <div class="flex gap-2 flex-wrap">
                                <button @click="filterCategory = 'All'" :class="['px-3 py-1 rounded-full text-xs font-bold transition', filterCategory === 'All' ? 'bg-white text-slate-900' : 'bg-slate-800 text-slate-400 hover:text-white']">All</button>
                                <button v-for="cat in categories" :key="cat" @click="filterCategory = cat" :class="['px-3 py-1 rounded-full text-xs font-bold transition', filterCategory === cat ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400 hover:text-white']">
                                    {{ cat }}
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button @click="initAddEntry" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-xs font-bold hover:bg-emerald-500"><i class="fa-solid fa-plus mr-1"></i> Add Manual</button>
                            <button @click="showImportModal = true" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold">Import JSON</button>
                            <button @click="exportData" class="px-4 py-2 bg-slate-800 text-indigo-400 rounded-lg text-xs font-bold">Export</button>
                            <button @click="clearNotebook" class="px-4 py-2 bg-slate-800 text-red-400 rounded-lg text-xs font-bold">Clear</button>
                        </div>
                    </div>

                    <div v-if="notebook.length === 0" class="text-center py-20 text-slate-600">
                        <i class="fa-solid fa-book-bookmark text-6xl mb-4"></i>
                        <p>Notebook is empty. Add words from Reader or manually.</p>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scrollbar pb-10">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="(item, idx) in filteredNotebook" :key="idx" 
                                :class="['bg-slate-900 p-5 rounded-2xl border transition relative group', item.type === 'sentence' ? 'border-amber-500/30' : 'border-slate-800 hover:border-indigo-500']">
                                
                                <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                    <button @click="toggleEdit(item)" class="text-slate-500 hover:text-indigo-400"><i :class="item.isEditing ? 'fa-solid fa-floppy-disk' : 'fa-solid fa-pen'"></i></button>
                                    <button @click="deleteItem(item)" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                                </div>

                                <span :class="['absolute top-4 right-16 text-[10px] uppercase font-bold px-2 py-0.5 rounded', item.type === 'sentence' ? 'bg-amber-900/30 text-amber-500' : 'bg-slate-800 text-slate-500']">{{ item.category || 'Uncategorized' }}</span>

                                <div v-if="!item.isEditing">
                                    <div class="flex items-center gap-3 mb-2 pr-12">
                                        <h4 :class="['font-bold text-white', item.type === 'sentence' ? 'text-lg leading-snug' : 'text-xl']">{{ item.text }}</h4>
                                        <button @click="speak(item.text)" class="text-indigo-500 hover:text-white shrink-0"><i class="fa-solid fa-volume-high text-xs"></i></button>
                                    </div>
                                    <p class="text-sm text-slate-400">{{ item.meaning_en }}</p>
                                    <p class="text-sm text-emerald-400">{{ item.meaning_cn }}</p>
                                </div>

                                <div v-else class="space-y-2">
                                    <input v-model="item.text" class="edit-input font-bold" placeholder="Content">
                                    <input v-model="item.meaning_en" class="edit-input" placeholder="English">
                                    <input v-model="item.meaning_cn" class="edit-input text-emerald-400" placeholder="Chinese">
                                    <input v-model="item.category" class="edit-input text-xs text-slate-400" placeholder="Category">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeTab === 'dictionary'" class="max-w-3xl mx-auto"><div class="relative"><input v-model="dictQuery" @keyup.enter="handleLookup" type="text" placeholder="Search..." class="w-full bg-slate-900 border border-slate-700 rounded-full px-6 py-4 text-white pr-32"><button @click="handleLookup" class="absolute right-2 top-2 bottom-2 px-6 bg-indigo-600 text-white rounded-full font-bold">Search</button></div><div v-if="dictResult" class="mt-8 bg-slate-900 p-8 rounded-3xl border border-slate-800 text-center"><h3 class="text-4xl font-bold text-white mb-2">{{ dictResult.term }}</h3><p class="text-slate-300">{{ dictResult.definition_en }}</p><p class="text-emerald-400">{{ dictResult.definition_cn }}</p><button @click="addToNotebook({text: dictResult.term, meaning_en: dictResult.definition_en, meaning_cn: dictResult.definition_cn, type: 'word'})" class="mt-6 px-6 py-2 bg-emerald-600 text-white rounded-lg font-bold">Save</button></div></div>
                </div>

            <div v-if="dictPopup" class="absolute bottom-8 right-8 w-80 bg-slate-800 border border-indigo-500/50 rounded-2xl shadow-2xl p-6 z-50">
                <div class="flex justify-between items-start mb-4"><h4 class="text-2xl font-bold text-white">{{ dictPopup.word }}</h4><button @click="dictPopup = null" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button></div>
                <div v-if="dictPopup.loading" class="text-center py-4"><i class="fa-solid fa-circle-notch fa-spin text-indigo-500"></i></div>
                <div v-else class="space-y-3"><div class="text-sm text-slate-300"><span class="text-indigo-400 font-bold block text-xs">EN</span> {{ dictPopup.meaning_en }}</div><div class="text-sm text-slate-300"><span class="text-emerald-400 font-bold block text-xs">CN</span> {{ dictPopup.meaning_cn }}</div><div class="flex gap-2 mt-4 pt-2 border-t border-slate-700"><button @click="speak(dictPopup.word)" class="flex-1 py-2 bg-slate-700 rounded-lg text-xs font-bold hover:bg-slate-600">Listen</button><button @click="addToNotebook({text: dictPopup.word, meaning_en: dictPopup.meaning_en, meaning_cn: dictPopup.meaning_cn, type: 'word'})" :class="['flex-1 py-2 rounded-lg text-xs font-bold', dictPopup.saved ? 'bg-emerald-600' : 'bg-indigo-600']">{{ dictPopup.saved ? 'Saved!' : 'Add to Note' }}</button></div></div>
            </div>

        </main>
    </div>

    <script type="importmap">
    { "imports": { "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js", "@google/genai": "https://esm.run/@google/genai" } }
    </script>

    <script type="module">
        import { createApp, ref, computed } from 'vue';
        import { GoogleGenAI } from "@google/genai";

        createApp({
            setup() {
                const currentModel = ref('gemini-1.5-flash');
                const isValidKey = ref(false);
                const showAuthModal = ref(true);
                const showAddModal = ref(false);
                const tempKey = ref('');
                const apiKey = ref(localStorage.getItem('pg_key') || '');
                const isLoading = ref(false);
                const loginError = ref('');
                
                const activeTab = ref('import');
                const importText = ref('');
                const contentData = ref(null);
                // Notebook Data Structure: { text, meaning_en, meaning_cn, type: 'word'|'sentence', category, isEditing }
                const notebook = ref(JSON.parse(localStorage.getItem('pg_notebook')) || []);
                const filterCategory = ref('All');
                const newEntry = ref({ text: '', meaning_en: '', meaning_cn: '', category: 'General', type: 'word' });
                
                const dictPopup = ref(null);
                const dictQuery = ref('');
                const dictResult = ref(null);
                
                const currentLang = ref({ name: 'Finnish', code: 'fi-FI', flag: 'ðŸ‡«ðŸ‡®' });
                const languages = [ { name: 'Finnish', code: 'fi-FI', flag: 'ðŸ‡«ðŸ‡®' }, { name: 'Japanese', code: 'ja-JP', flag: 'ðŸ‡¯ðŸ‡µ' }, { name: 'English', code: 'en-US', flag: 'ðŸ‡ºðŸ‡¸' }, { name: 'German', code: 'de-DE', flag: 'ðŸ‡©ðŸ‡ª' } ];
                const tabs = [ { id: 'import', label: 'Import', icon: 'fa-file-import' }, { id: 'news', label: 'Reader', icon: 'fa-book-open' }, { id: 'notebook', label: 'Notebook', icon: 'fa-book-bookmark' }, { id: 'dictionary', label: 'Dictionary', icon: 'fa-book' }, { id: 'scanner', label: 'Scanner', icon: 'fa-camera' }, { id: 'grammar', label: 'Grammar', icon: 'fa-microchip' }, { id: 'scenario', label: 'Scenario', icon: 'fa-comments' }, { id: 'journal', label: 'Journal', icon: 'fa-pen-nib' } ];

                const categories = computed(() => {
                    const cats = new Set(notebook.value.map(i => i.category || 'Uncategorized'));
                    return Array.from(cats).sort();
                });

                const filteredNotebook = computed(() => {
                    if (filterCategory.value === 'All') return notebook.value;
                    return notebook.value.filter(i => (i.category || 'Uncategorized') === filterCategory.value);
                });

                const verifyKey = async () => { if(!tempKey.value) return; isLoading.value = true; try { const ai = new GoogleGenAI({ apiKey: tempKey.value }); await ai.models.generateContent({ model: currentModel.value, contents: "Hi" }); apiKey.value = tempKey.value; localStorage.setItem('pg_key', tempKey.value); isValidKey.value = true; showAuthModal.value = false; } catch(e) { loginError.value = e.message; } finally { isLoading.value = false; } };
                const skipLogin = () => { showAuthModal.value = false; };
                if(apiKey.value) { isValidKey.value = true; showAuthModal.value = false; }

                const callAI = async (prompt, schema = null) => { if(!isValidKey.value) return null; isLoading.value = true; try { const ai = new GoogleGenAI({ apiKey: apiKey.value }); const config = schema ? { responseMimeType: "application/json", responseSchema: schema } : {}; const res = await ai.models.generateContent({ model: currentModel.value, contents: prompt, config }); return schema ? JSON.parse(res.text) : res.text; } catch(e) { alert("AI Error"); return null; } finally { isLoading.value = false; } };

                const processContent = async (mode) => {
                    if (!importText.value.trim()) return;
                    if (mode === 'json') { try { contentData.value = { ...JSON.parse(importText.value), isAiAnalyzed: true }; activeTab.value = 'news'; } catch(e){ alert("Invalid JSON"); } return; }
                    if (mode === 'raw') { contentData.value = { title: "Raw Text", main_text: importText.value, isAiAnalyzed: false }; activeTab.value = 'news'; }
                    else { const schema = { type: "OBJECT", properties: { title: { type: "STRING" }, main_text: { type: "STRING" }, translation_en: { type: "STRING" }, translation_cn: { type: "STRING" }, vocabulary: { type: "ARRAY", items: { type: "OBJECT", properties: { word: { type: "STRING" }, meaning_en: { type: "STRING" }, meaning_cn: { type: "STRING" } } } } } }; const data = await callAI(`Analyze ${currentLang.value.name}: "${importText.value}"`, schema); if(data) { contentData.value = { ...data, isAiAnalyzed: true }; activeTab.value = 'news'; } }
                };

                const splitText = (text) => text ? text.split(/(\s+|[.,!?;:"()])/).map(t => { if(t.match(/\n/)) return {type:'newline'}; if(t.trim().length>0 && !t.match(/[.,!?;:"()]/)) return {type:'word', text:t}; return {type:'punct', text:t}; }).filter(Boolean) : [];

                const lookupWord = async (word) => {
                    const existing = notebook.value.find(n => n.text.toLowerCase() === word.toLowerCase());
                    if (existing) { dictPopup.value = { word: existing.text, meaning_en: existing.meaning_en, meaning_cn: existing.meaning_cn, loading: false, saved: true }; return; }
                    if(!isValidKey.value) { dictPopup.value = { word, meaning_en: "Offline", meaning_cn: "Login required", loading: false, saved: false }; return; }
                    dictPopup.value = { word, loading: true, saved: false };
                    const schema = { type: "OBJECT", properties: { word: { type: "STRING" }, meaning_en: { type: "STRING" }, meaning_cn: { type: "STRING" } } };
                    const data = await callAI(`Define "${word}" in ${currentLang.value.name} (EN/CN).`, schema);
                    if(data) dictPopup.value = { ...data, loading: false, saved: false };
                };

                // NOTEBOOK LOGIC
                const addToNotebook = (item) => {
                    if(!notebook.value.some(x => x.text === item.text)) {
                        notebook.value.unshift({ 
                            text: item.text || item.word, 
                            meaning_en: item.meaning_en, 
                            meaning_cn: item.meaning_cn, 
                            type: item.type || 'word',
                            category: 'Uncategorized',
                            isEditing: false
                        });
                        saveNotebook();
                    }
                    if(dictPopup.value) dictPopup.value.saved = true;
                };

                const initAddEntry = () => { newEntry.value = { text: '', meaning_en: '', meaning_cn: '', category: 'General', type: 'word' }; showAddModal.value = true; };
                const saveNewEntry = () => { addToNotebook(newEntry.value); showAddModal.value = false; };
                
                const toggleEdit = (item) => {
                    if (item.isEditing) saveNotebook(); // Save on close
                    item.isEditing = !item.isEditing;
                };
                const deleteItem = (item) => {
                    const idx = notebook.value.indexOf(item);
                    if (idx > -1) { notebook.value.splice(idx, 1); saveNotebook(); }
                };

                const saveNotebook = () => localStorage.setItem('pg_notebook', JSON.stringify(notebook.value));
                const clearNotebook = () => { notebook.value = []; saveNotebook(); };
                const exportData = () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(notebook.value)], {type:'application/json'})); a.download = 'notes.json'; a.click(); };
                const speak = (text) => { window.speechSynthesis.cancel(); const ut = new SpeechSynthesisUtterance(text); ut.lang = currentLang.value.code; window.speechSynthesis.speak(ut); };
                const handleLookup = async () => { if(!isValidKey.value) return; const schema = { type: "OBJECT", properties: { term: { type: "STRING" }, pos: { type: "STRING" }, definition_en: { type: "STRING" }, definition_cn: { type: "STRING" } } }; const data = await callAI(`Define "${dictQuery.value}"`, schema); if(data) dictResult.value = data; };

                return {
                    isValidKey, showAuthModal, showAddModal, tempKey, isLoading, verifyKey, skipLogin, loginError,
                    activeTab, tabs, currentLang, languages,
                    importText, contentData, notebook, categories, filterCategory, filteredNotebook, newEntry,
                    dictPopup, dictQuery, dictResult,
                    processContent, lookupWord, addToNotebook, speak, clearNotebook, exportData, splitText,
                    initAddEntry, saveNewEntry, toggleEdit, deleteItem, handleLookup
                };
            }
        }).mount('#app');
    </script>
</body>
</html>