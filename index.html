<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyGlot v14.1 | Stable Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        [v-cloak] { display: none; }
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .token-hover:hover { background-color: rgba(99, 102, 241, 0.2); border-radius: 4px; cursor: pointer; color: #818cf8; }
        .highlight-grammar { border-bottom: 2px dashed #fbbf24; }
        .highlight-vocab { border-bottom: 2px solid #34d399; }
        
        /* Loading Animation */
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #6366f1; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased h-screen overflow-hidden flex">

    <div id="app" v-cloak class="w-full h-full flex">
        
        <div v-if="!isValidKey" class="fixed inset-0 z-50 bg-black/90 flex items-center justify-center backdrop-blur-sm">
            <div class="bg-slate-800 p-8 rounded-3xl w-full max-w-md border border-slate-700 shadow-2xl text-center">
                <div class="w-16 h-16 bg-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-6 text-2xl text-white"><i class="fa-solid fa-shield-halved"></i></div>
                <h2 class="text-2xl font-bold text-white mb-2">PolyGlot Stable</h2>
                <p class="text-slate-400 text-sm mb-6">Enter your Google Gemini API Key once. It will be saved locally.</p>
                <input v-model="tempKey" type="password" placeholder="AIza..." class="w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-white focus:border-emerald-500 outline-none mb-4 font-mono">
                <button @click="verifyKey" :disabled="!tempKey || isLoading" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold transition">
                    <span v-if="isLoading"><i class="fa-solid fa-spinner fa-spin"></i> Verifying...</span>
                    <span v-else>Save & Start System</span>
                </button>
            </div>
        </div>

        <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col h-full shrink-0">
            <div class="p-6">
                <h1 class="text-xl font-black text-white flex items-center gap-2">
                    <i class="fa-solid fa-brain text-emerald-500"></i> PolyGlot v14.1
                </h1>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-1">Stable Engine</p>
            </div>

            <div class="px-4 mb-6">
                <div class="grid grid-cols-2 gap-2">
                    <button v-for="lang in languages" :key="lang.name" @click="currentLang = lang" 
                        :class="['px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition', currentLang.name === lang.name ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700']">
                        <span>{{ lang.flag }}</span> {{ lang.name }}
                    </button>
                </div>
            </div>

            <nav class="flex-1 px-2 space-y-1 overflow-y-auto custom-scrollbar">
                <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id"
                    :class="['w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition', activeTab === tab.id ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'text-slate-400 hover:text-white hover:bg-slate-800']">
                    <i :class="['fa-solid w-5', tab.icon]"></i> {{ tab.label }}
                </button>
            </nav>

            <div class="p-4 border-t border-slate-800">
                <button @click="resetSystem" class="text-xs text-red-400 flex items-center gap-2 hover:text-red-300"><i class="fa-solid fa-power-off"></i> Reset API Key</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-950 relative">
            
            <header class="h-16 border-b border-slate-800 flex items-center justify-between px-8 bg-slate-900/50 backdrop-blur">
                <h2 class="text-lg font-bold text-white capitalize">{{ activeTab.replace('-', ' ') }} Mode</h2>
                <div class="flex items-center gap-4">
                    <span class="text-xs font-mono text-emerald-400 bg-emerald-900/30 px-2 py-1 rounded">Model: Gemini 1.5 Flash</span>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8 custom-scrollbar relative">
                
                <div v-if="activeTab === 'news'" class="max-w-4xl mx-auto space-y-8">
                    <div v-if="!contentData" class="bg-slate-900 p-10 rounded-3xl border border-slate-800 text-center">
                        <i class="fa-solid fa-book-open text-5xl text-emerald-500 mb-6"></i>
                        <h3 class="text-2xl font-bold text-white mb-2">Generate Learning Material</h3>
                        <p class="text-slate-400 mb-8">Choose a topic or let AI decide.</p>
                        <div class="flex gap-4 justify-center">
                            <input v-model="topicInput" type="text" placeholder="e.g., Technology, Culture..." class="bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white outline-none focus:border-emerald-500 w-64">
                            <button @click="generateContent('news')" :disabled="isLoading" class="bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-3 rounded-xl font-bold transition flex items-center gap-2">
                                <i v-if="isLoading" class="fa-solid fa-spinner fa-spin"></i>
                                <span v-else>Generate</span>
                            </button>
                        </div>
                    </div>

                    <div v-if="contentData" class="animate-in fade-in slide-in-from-bottom-4">
                        <div class="flex justify-between mb-4">
                            <button @click="contentData = null" class="text-slate-400 hover:text-white"><i class="fa-solid fa-arrow-left"></i> Back</button>
                            <button @click="speak(contentData.main_text)" class="bg-emerald-600 text-white px-4 py-1 rounded-full text-sm hover:bg-emerald-500"><i class="fa-solid fa-volume-high mr-1"></i> Read Aloud</button>
                        </div>

                        <div class="bg-white text-slate-900 p-8 rounded-3xl shadow-xl mb-6">
                            <h2 class="text-3xl font-black mb-6">{{ contentData.title }}</h2>
                            <p class="text-xl leading-loose font-medium select-text">
                                <span v-for="(word, i) in contentData.main_text.split(' ')" :key="i" 
                                    @click="lookupWord(word)" 
                                    class="token-hover">{{ word }} </span>
                            </p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                                <h4 class="text-xs font-bold text-emerald-400 uppercase mb-4 tracking-widest">Full Translation</h4>
                                <div class="space-y-4">
                                    <p class="text-slate-300 text-sm"><strong class="text-white">EN:</strong> {{ contentData.translation_en }}</p>
                                    <p class="text-slate-300 text-sm"><strong class="text-white">CN:</strong> {{ contentData.translation_cn }}</p>
                                </div>
                            </div>

                            <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800 h-96 overflow-y-auto custom-scrollbar">
                                <h4 class="text-xs font-bold text-indigo-400 uppercase mb-4 tracking-widest">Vocabulary List</h4>
                                <div class="space-y-3">
                                    <div v-for="v in contentData.vocabulary" :key="v.word" class="flex justify-between items-start p-3 bg-slate-800 rounded-xl group">
                                        <div>
                                            <p class="text-white font-bold text-lg">{{ v.word }}</p>
                                            <p class="text-xs text-slate-400">{{ v.meaning_en }} | {{ v.meaning_cn }}</p>
                                        </div>
                                        <button @click="addToNotebook(v)" class="text-slate-500 hover:text-emerald-400"><i class="fa-solid fa-plus-circle"></i></button>
                                    </div>
                                </div>
                            </div>

                            <div class="md:col-span-2 bg-slate-900 p-6 rounded-2xl border border-slate-800">
                                <h4 class="text-xs font-bold text-amber-400 uppercase mb-4 tracking-widest">Grammar Analysis</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div v-for="g in contentData.grammar" :key="g.point" class="p-4 bg-slate-800/50 rounded-xl border border-slate-700">
                                        <p class="text-amber-400 font-bold mb-1">{{ g.point }}</p>
                                        <p class="text-slate-300 text-sm">{{ g.explanation }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeTab === 'import'" class="max-w-3xl mx-auto">
                    <div class="bg-slate-900 p-8 rounded-3xl border border-slate-800">
                        <h3 class="text-2xl font-bold text-white mb-4">Import Content</h3>
                        <p class="text-slate-400 text-sm mb-6">Paste any text (from your PDFs) or JSON here. AI will analyze it.</p>
                        <textarea v-model="importText" rows="10" class="w-full bg-slate-950 border border-slate-700 rounded-xl p-4 text-slate-300 font-mono text-sm focus:border-emerald-500 outline-none mb-4" placeholder="Paste Japanese/Target Language text here..."></textarea>
                        <button @click="processImport" :disabled="!importText || isLoading" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold transition">
                            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Analyze & Import
                        </button>
                    </div>
                </div>

                <div v-if="activeTab === 'notebook'" class="max-w-5xl mx-auto">
                    <div class="flex justify-between mb-6">
                        <h3 class="text-2xl font-bold text-white">Knowledge Bank</h3>
                        <div class="flex gap-2">
                            <button @click="exportData" class="px-4 py-2 bg-slate-800 text-emerald-400 rounded-lg text-xs font-bold hover:bg-slate-700">Export JSON</button>
                            <button @click="clearNotebook" class="px-4 py-2 bg-slate-800 text-red-400 rounded-lg text-xs font-bold hover:bg-slate-700">Clear All</button>
                        </div>
                    </div>
                    
                    <div v-if="notebook.length === 0" class="text-center py-20 text-slate-600">
                        <i class="fa-solid fa-book text-6xl mb-4"></i>
                        <p>Notebook is empty. Add words from News or Dictionary.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div v-for="(item, idx) in notebook" :key="idx" class="bg-slate-900 p-5 rounded-2xl border border-slate-800 hover:border-emerald-500 transition group relative">
                            <button @click="notebook.splice(idx, 1); saveNotebook()" class="absolute top-4 right-4 text-slate-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                            <div class="flex items-center gap-3 mb-2">
                                <h4 class="text-xl font-bold text-white">{{ item.word }}</h4>
                                <button @click="speak(item.word)" class="text-emerald-500 hover:text-white"><i class="fa-solid fa-volume-high text-xs"></i></button>
                            </div>
                            <p class="text-sm text-slate-400 line-clamp-2">{{ item.meaning_en }}</p>
                            <p class="text-sm text-slate-400">{{ item.meaning_cn }}</p>
                            <span class="absolute bottom-4 right-4 text-[10px] text-slate-600 uppercase">{{ item.lang }}</span>
                        </div>
                    </div>
                </div>

                <div v-if="activeTab === 'scenario'" class="max-w-2xl mx-auto h-full flex flex-col pb-4">
                    <div class="flex-1 bg-slate-900 rounded-3xl border border-slate-800 p-6 overflow-y-auto custom-scrollbar mb-4 space-y-4">
                        <div v-if="chatMessages.length === 0" class="text-center py-10">
                            <p class="text-slate-500 mb-4">Select a scenario to start</p>
                            <div class="flex flex-wrap justify-center gap-2">
                                <button v-for="s in ['Coffee Shop', 'Airport', 'Business Meeting']" @click="startScenario(s)" class="px-4 py-2 bg-slate-800 rounded-full text-sm hover:bg-emerald-600 transition">{{ s }}</button>
                            </div>
                        </div>
                        <div v-for="msg in chatMessages" :key="msg.id" :class="['flex', msg.role === 'user' ? 'justify-end' : 'justify-start']">
                            <div :class="['max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed', msg.role === 'user' ? 'bg-emerald-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 rounded-tl-none border border-slate-700']">
                                <p>{{ msg.content }}</p>
                                <p v-if="msg.translation" class="text-xs text-slate-500 mt-2 pt-2 border-t border-slate-700">{{ msg.translation }}</p>
                                <button v-if="msg.role === 'ai'" @click="speak(msg.content)" class="mt-2 text-emerald-400 text-xs"><i class="fa-solid fa-volume-high"></i></button>
                            </div>
                        </div>
                        <div v-if="isLoading" class="flex justify-start"><div class="bg-slate-800 p-4 rounded-2xl rounded-tl-none"><i class="fa-solid fa-ellipsis fa-bounce text-slate-500"></i></div></div>
                    </div>
                    <div class="flex gap-2">
                        <input v-model="chatInput" @keyup.enter="sendChatMessage" type="text" placeholder="Type your response..." class="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white outline-none focus:border-emerald-500">
                        <button @click="sendChatMessage" :disabled="!chatInput || isLoading" class="bg-emerald-600 text-white px-6 rounded-xl hover:bg-emerald-500"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>

            </div>

            <div v-if="dictPopup" class="absolute bottom-8 right-8 w-80 bg-slate-800 border border-emerald-500/50 rounded-2xl shadow-2xl p-6 animate-in slide-in-from-bottom-10 z-50">
                <div class="flex justify-between items-start mb-4">
                    <h4 class="text-2xl font-bold text-white">{{ dictPopup.word }}</h4>
                    <button @click="dictPopup = null" class="text-slate-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
                </div>
                <div v-if="dictPopup.loading" class="text-center py-4"><i class="fa-solid fa-circle-notch fa-spin text-emerald-500"></i></div>
                <div v-else class="space-y-3">
                    <div class="text-sm text-slate-300"><span class="text-indigo-400 font-bold">EN:</span> {{ dictPopup.meaning_en }}</div>
                    <div class="text-sm text-slate-300"><span class="text-emerald-400 font-bold">CN:</span> {{ dictPopup.meaning_cn }}</div>
                    <div class="text-xs text-slate-500 italic mt-2">{{ dictPopup.pos }}</div>
                    <div class="flex gap-2 mt-4">
                        <button @click="speak(dictPopup.word)" class="flex-1 py-2 bg-slate-700 rounded-lg text-xs font-bold hover:bg-slate-600">Listen</button>
                        <button @click="addToNotebook(dictPopup)" class="flex-1 py-2 bg-emerald-600 rounded-lg text-xs font-bold hover:bg-emerald-500">Save</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="importmap">
    {
      "imports": {
        "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
        "@google/genai": "https://esm.run/@google/genai"
      }
    }
    </script>

    <script type="module">
        import { createApp, ref, onMounted, watch } from 'vue';
        import { GoogleGenAI } from "@google/genai";

        createApp({
            setup() {
                // --- STATE ---
                const MODEL_NAME = "gemini-1.5-flash"; // [FIXED] Changed to 1.5-Flash for stability
                const isValidKey = ref(false);
                const tempKey = ref('');
                const apiKey = ref(localStorage.getItem('pg_key') || '');
                const isLoading = ref(false);
                
                const activeTab = ref('news');
                const topicInput = ref('');
                const importText = ref('');
                const contentData = ref(null);
                const notebook = ref(JSON.parse(localStorage.getItem('pg_notebook')) || []);
                const chatMessages = ref([]);
                const chatInput = ref('');
                const dictPopup = ref(null);

                const currentLang = ref({ name: 'Japanese', code: 'ja-JP', flag: 'ðŸ‡¯ðŸ‡µ' });
                const languages = [
                    { name: 'Japanese', code: 'ja-JP', flag: 'ðŸ‡¯ðŸ‡µ' },
                    { name: 'English', code: 'en-US', flag: 'ðŸ‡ºðŸ‡¸' },
                    { name: 'German', code: 'de-DE', flag: 'ðŸ‡©ðŸ‡ª' },
                    { name: 'French', code: 'fr-FR', flag: 'ðŸ‡«ðŸ‡·' },
                    { name: 'Korean', code: 'ko-KR', flag: 'ðŸ‡°ðŸ‡·' }
                ];
                
                const tabs = [
                    { id: 'news', label: 'Smart Reading', icon: 'fa-book-open' },
                    { id: 'import', label: 'Import Content', icon: 'fa-file-import' },
                    { id: 'scenario', label: 'Scenario Dojo', icon: 'fa-comments' },
                    { id: 'notebook', label: 'Notebook', icon: 'fa-book-bookmark' }
                ];

                // --- KEY MANAGEMENT ---
                const verifyKey = async () => {
                    if(!tempKey.value) return;
                    isLoading.value = true;
                    try {
                        const ai = new GoogleGenAI({ apiKey: tempKey.value });
                        await ai.models.generateContent({ model: MODEL_NAME, contents: "Hi" });
                        apiKey.value = tempKey.value;
                        localStorage.setItem('pg_key', tempKey.value);
                        isValidKey.value = true;
                    } catch(e) {
                        alert("Invalid Key or Rate Limit: " + e.message);
                    } finally { isLoading.value = false; }
                };

                const resetSystem = () => {
                    if(confirm("Clear API Key and reset?")) {
                        localStorage.removeItem('pg_key');
                        location.reload();
                    }
                };

                if(apiKey.value) isValidKey.value = true;

                // --- AI CORE ---
                const callAI = async (prompt, schema = null) => {
                    if(!apiKey.value) return null;
                    isLoading.value = true;
                    try {
                        const ai = new GoogleGenAI({ apiKey: apiKey.value });
                        const config = schema ? { responseMimeType: "application/json", responseSchema: schema } : {};
                        const res = await ai.models.generateContent({ model: MODEL_NAME, contents: prompt, config });
                        const text = res.text;
                        return schema ? JSON.parse(text) : text;
                    } catch(e) {
                        alert("AI Error: " + e.message);
                        return null;
                    } finally { isLoading.value = false; }
                };

                // --- FEATURES ---

                // 1. Generate News / Reading Content
                const generateContent = async (source) => {
                    const prompt = source === 'news' 
                        ? `Generate a B1/B2 level article in ${currentLang.value.name} about "${topicInput.value || 'Current Trends'}". Return JSON.` 
                        : `Analyze this text in ${currentLang.value.name}: "${importText.value}". Return JSON.`;

                    const schema = {
                        type: "OBJECT",
                        properties: {
                            title: { type: "STRING" },
                            main_text: { type: "STRING" },
                            translation_en: { type: "STRING" },
                            translation_cn: { type: "STRING" },
                            vocabulary: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        word: { type: "STRING" },
                                        meaning_en: { type: "STRING" },
                                        meaning_cn: { type: "STRING" }
                                    }
                                }
                            },
                            grammar: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        point: { type: "STRING" },
                                        explanation: { type: "STRING" }
                                    }
                                }
                            }
                        }
                    };

                    const data = await callAI(prompt, schema);
                    if(data) {
                        contentData.value = data;
                        if(source === 'import') activeTab.value = 'news';
                        topicInput.value = '';
                        importText.value = '';
                    }
                };

                const processImport = () => generateContent('import');

                // 2. Dictionary / Lookup
                const lookupWord = async (word) => {
                    word = word.replace(/[.,!?]/g, '');
                    dictPopup.value = { word, loading: true };
                    
                    const schema = {
                        type: "OBJECT",
                        properties: {
                            word: { type: "STRING" },
                            pos: { type: "STRING" },
                            meaning_en: { type: "STRING" },
                            meaning_cn: { type: "STRING" }
                        }
                    };
                    
                    const data = await callAI(`Define "${word}" in ${currentLang.value.name} with EN and CN meanings.`, schema);
                    if(data) {
                        dictPopup.value = { ...data, loading: false };
                    }
                };

                // 3. Scenario Dojo
                const startScenario = async (topic) => {
                    chatMessages.value = [];
                    const schema = { type: "OBJECT", properties: { message: { type: "STRING" }, translation: { type: "STRING" } } };
                    const data = await callAI(`Start a roleplay in ${currentLang.value.name} about "${topic}". I am the student. Return JSON with message and translation_cn.`, schema);
                    if(data) {
                        chatMessages.value.push({ id: Date.now(), role: 'ai', content: data.message, translation: data.translation });
                        speak(data.message);
                    }
                };

                const sendChatMessage = async () => {
                    if(!chatInput.value) return;
                    const msg = chatInput.value;
                    chatMessages.value.push({ id: Date.now(), role: 'user', content: msg });
                    chatInput.value = '';
                    
                    const history = chatMessages.value.map(m => `${m.role}: ${m.content}`).join('\n');
                    const schema = { type: "OBJECT", properties: { message: { type: "STRING" }, translation: { type: "STRING" } } };
                    const data = await callAI(`History:\n${history}\n\nReply in ${currentLang.value.name} naturally. JSON with CN translation.`, schema);
                    
                    if(data) {
                        chatMessages.value.push({ id: Date.now()+1, role: 'ai', content: data.message, translation: data.translation });
                        speak(data.message);
                    }
                };

                // 4. Utils (TTS, Notebook)
                const speak = (text) => {
                    window.speechSynthesis.cancel();
                    const ut = new SpeechSynthesisUtterance(text);
                    ut.lang = currentLang.value.code;
                    window.speechSynthesis.speak(ut);
                };

                const addToNotebook = (item) => {
                    if(notebook.value.some(x => x.word === item.word)) return alert("Already saved!");
                    notebook.value.unshift({ ...item, lang: currentLang.value.name });
                    saveNotebook();
                };

                const saveNotebook = () => localStorage.setItem('pg_notebook', JSON.stringify(notebook.value));
                const clearNotebook = () => { notebook.value = []; saveNotebook(); };
                const exportData = () => {
                    const blob = new Blob([JSON.stringify(notebook.value, null, 2)], {type:'application/json'});
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'polyglot_notes.json';
                    a.click();
                };

                return {
                    isValidKey, tempKey, apiKey, isLoading, verifyKey, resetSystem,
                    activeTab, tabs, currentLang, languages,
                    topicInput, importText, contentData, notebook, chatMessages, chatInput, dictPopup,
                    generateContent, processImport, lookupWord, addToNotebook, speak,
                    startScenario, sendChatMessage, clearNotebook, exportData, saveNotebook
                };
            }
        }).mount('#app');
    </script>
</body>
</html>